# Structure

The module files are located in the `/modules` directory. The directory can be set via $MODULES_DIR variable. The global hook files are located in the `/global-hooks` directory (you can set your own directory with the $GLOBAL_HOOKS_DIR variable).

# Initialization

During the start, Addon-operator finds and initializes all global hooks. For more info, see [HOOKS](HOOKS.md#initialization-of-global-hooks).

Addon-operator installs a separate instance of tiller in the namespace where the addon-operator is running to store the information about helm-releases of modules.

# Main loop

After initialization Addon-operator executes all global `onStartup` hooks and starts the modules discovery process.

The modules discovery process finds all enabled modules and starts them.

During start-up, the module executes its `onStartup` hook and initializes the installation of a helm chart. Prior to the installation of a helm chart, the `beforeHelm` hook is executed. The `afterHelm` hook is executed after the installation.

Then the main loop starts. It processes scheduled and Kubernetes objects’ events, as well as a module activation event when values change and the modules restart event.

# Module lifecycle

The `onStartup` hooks of all modules are executed during the first deployment of a Pod with an Addon-operator.

Next, the modules are run in alphabetical order with `helm upgrade --install`. Prior to launching helm, `beforeHelm` hooks are executed, after the launch the `afterHelm` hooks are executed.

After the launch module would start to respond to two types of events:

- `schedule` — events that are generated by the crontab scheduler built in the addon-operator;
- `onKubernetesEvent` — events within the cluster that api-server announces to Addon-operator.

When module is deactivated, Addon-operator launch command `helm delete --purge` and after the release deletion, the `afterDeleteHelm` hooks are executed.

All necessary hooks will be restarted if there are errors during the module activation or deactivation. For example, if an error occurred in the hook with `afterHelm` binding during the first module execution, then after a 5 seconds delay the `onStartup` and `beforeHelm` hooks are executed, the helm chart is installed and then `afterHelm` hooks are executed.

# Modules discovery

Addon-operator makes a list of all enabled modules for their execution and a list of disabled modules for the deletion of their helm releases. This process is called `module discovery` and is started in the following cases:

- during the start of addon-operator
- when an event to restart all modules occurs (see [VALUES](VALUES.md)).

For each module in the values.yaml and in the ConfigMap/addon-operator there is a key with the name of a module that may contain:

- false
- true or the object with parameters

The key may be absent. In this case, the `true` value is considered.

If combined values from values.yaml and ConfigMap/addon-operator equal to `false`, then the module is disabled.

If the value is not `false`, the additional check is conducted – the `enabled` script is executed (see below). If there is a script and it returns `false`, then the module is considered disabled.

If an error occurs during the modules discovery process, then the module discovery is restarted every 5 seconds until successful execution. In this case, the execution of hooks with `schedule` and `onKubernetesEvent` bindings will be blocked.

As a result of a module discovery process the tasks for the execution of all *enabled* modules, deletion of all *disabled* modules, and execution of all global hook with the `afterAll` binding are added to the queue.

## Enabled script

A script or an executable file that returns a status of the module. The script has access to the module values in $VALUES_PATH and $CONFIG_VALUES_PATH files, more details about the values are available in [VALUES](VALUES.md#using-values-in-enabled-script). The variable $MODULE_ENABLED_RESULT passes the path to the file into which the script should write the module status: true or false.

Below is an example of the `enabled` script that disables the module when parameter `param2` is set to "stopMePlease".


```bash
#!/usr/bin/env bash

param2=$(jq -r '.simpleModule.param2' $VALUES_PATH)

if [[ $param2 == "stopMePlease" ]] ; then
  echo "false" > $MODULE_ENABLED_RESULT
else
  echo "true" > $MODULE_ENABLED_RESULT
fi

```

## before_config script

A script or an executable file that runs once when module is enabled before running all hooks with `--config` flag. The script has access to the module values in $VALUES_PATH and $CONFIG_VALUES_PATH files, more details about the values are available in [VALUES](VALUES.md#using-values-in-enabled-script). Script can be used to setup module requirements in cluster, for example, to install CRDs.

# Tasks queue

Addon-operator cycle works like a simple FIFO queue. The Addon-operator processes an event, creates a task and adds it to the queue. The queue handler runs the current task and proceeds to the next. Each task is processed until successful completion. In case of an error, the task is returned to the top of the queue and executed after a 5 seconds delay. When executing tasks for the `onKubernetesEvent` and `schedule` events, the queue handler may ignore the execution errors if the `allowFailure: true` flag is specified in the binding configuration.

# Queue monitoring

You can use Prometheus metrics to monitor the queue. For details, see [METRICS](METRICS.md).

# Debug

Several tools are available for the debugging of addon-operator and hooks:

- You can get logs of an Addon-operator’s pod for analysis (by executing `kubectl logs -f po/POD_NAME`)
- You can set the environment variable RLOG_LOG_LEVEL=DEBUG to include the detailed debugging data into logs
- You can run the Addon-operator with the `--debug=yes` argument to obtain even more detailed debugging information and save it to logs
- You can view the contents of the working queue via the HTTP request of `/queue` endpoint:

```bash
kubectl port-forward po/addon-operator 9115:9115

curl localhost:9115/queue
```

